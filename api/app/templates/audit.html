{% extends "base.html" %}
{% block title %}Sentinelle ‚Äî Audit Trail{% endblock %}

{% block content %}
<div class="page-header">
    <h2>üìã Historique des D√©cisions</h2>
    <p>Historique des {{ decisions|length }} derni√®res d√©cisions trac√©es.</p>
</div>

<!-- Stats -->
<div class="stats-row">
    <div class="stat-card">
        <div class="stat-label">Total des Dossiers</div>
        <div class="stat-value">{{ decisions|length }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Accept√©s</div>
        <div class="stat-value" style="color: var(--accent-green);">{{ decisions|selectattr('decision', 'equalto',
            'ACCEPT')|list|length }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Rejet√©s</div>
        <div class="stat-value" style="color: var(--accent-red);">{{ decisions|selectattr('decision', 'equalto',
            'REJECT')|list|length }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Alertes</div>
        <div class="stat-value" style="color: var(--accent-orange);">{{ decisions|selectattr('decision', 'equalto',
            'ALERT')|list|length + decisions|selectattr('decision', 'equalto', 'REVIEW')|list|length }}</div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <span class="card-icon">üîç</span>
        <h3>Derni√®res D√©cisions</h3>
    </div>

    {% if decisions %}
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ID D√©cision</th>
                    <th>Date</th>
                    <th>D√©cision</th>
                    <th>Score Risque</th>
                    <th>Score Fraude</th>
                    <th>R√®gle</th>
                </tr>
            </thead>
            <tbody>
                {% for d in decisions %}
                <tr>
                    <td style="font-family: 'SF Mono', monospace; font-size: 11px;">{{ d.decision_id }}</td>
                    <td>{{ d.created_at.strftime('%d/%m/%Y %H:%M') if d.created_at else '‚Äî' }}</td>
                    <td>
                        {% set badge = {
                        'ACCEPT': 'table-badge-accept',
                        'REJECT': 'table-badge-reject',
                        'REVIEW': 'table-badge-review',
                        'ALERT': 'table-badge-alert'
                        } %}
                        {% set badge_text = {
                        'ACCEPT': 'ACCEPT√â',
                        'REJECT': 'REJET√â',
                        'REVIEW': 'R√âVISION',
                        'ALERT': 'ALERTE'
                        } %}
                        <span class="table-badge {{ badge.get(d.decision, '') }}">{{ badge_text.get(d.decision,
                            d.decision) }}</span>
                    </td>
                    <td>{{ "%.1f"|format(d.risk_score * 100) }}%</td>
                    <td>{{ "%.1f"|format(d.fraud_score * 100) }}%</td>
                    <td style="font-size: 11px; color: var(--text-muted);">{{ d.policy_rule }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="icon">üì≠</div>
        <p>Aucune d√©cision enregistr√©e.<br>Soumettez un dossier depuis le Tableau de Bord pour commencer.</p>
    </div>
    {% endif %}
</div>
{% endblock %}